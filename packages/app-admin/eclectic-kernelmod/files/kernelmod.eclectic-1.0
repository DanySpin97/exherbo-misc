# Copyright 2009 Pierre Lejeune <superheron@gmail.com>
# Distributed under the terms of the GNU General Public License v2

DESCRIPTION="Manage Linux kernel modules set for Paludis"
MAINTAINER="superheron@gmail.com"
VERSION="1.0"

KERNELMOD_SET_PATH="/etc/paludis/sets/kernelmod.conf"

inherit paludis

is_in_kernelmod_set() {
    local spec inSet="false"
    if [[ -f ${KERNELMOD_SET_PATH} ]]; then
        for spec in `cat ${KERNELMOD_SET_PATH}`; do
            [[ -z ${spec/*${1}*} ]] && inSet="false" || inSet="true"
            [[ ${inSet} == "true" ]] && break
        done
    else
        inSet="false"
    fi
    echo ${inSet}
}

### list action ###

describe_list() {
	echo "List kernel modules currently in kernelmod set."
}

do_list() {
    [[ -f ${KERNELMOD_SET_PATH} ]] && cat ${KERNELMOD_SET_PATH} || echo "Kernelmod set is not existing yet."
}

### add action ###

describe_add() {
	echo "Add kernel module package to kernelmod set."
}

describe_add_parameters() {
	echo "<depSpec>"
}

describe_add_options() {
	echo "depSpec : depSpec to add to kernelmod set."
}

do_add() {
	if [[ -z ${1} ]]; then
    	# no parameter
	    die -q "Please specify DepSpec to add to kernelmod set."
    else
        if [[ ! -d "/etc/paludis/sets" ]]; then
            mkdir /etc/paludis/sets
        fi
        if [[ -z $(paludis_best-version ${1}) ]]; then
            die -q "DepSpec ${1} is not installed."
        elif [[ $(is_in_kernelmod_set ${1}) == "true" ]]; then
            die -q "DepSpec already in kernelmod set."
        else
            echo -e "Adding ${1} to kernelmod set."
            echo "* ${1}" >> ${KERNELMOD_SET_PATH}
        fi
    fi
}

### delete action ###

describe_delete() {
    echo "Remove kernel module package from kernelmod set."
}

describe_delete_parameters() {
    echo "<depSpec>"
}

describe_delete_options() {
    echo "depSpec : depSpec to remove from kernelmod set."
}

do_delete() {
    if [[ -z ${1} ]]; then
        die -q "Please specify DepSpec to remove from kernelmod set."
    elif [[ ! -f ${KERNELMOD_SET_PATH} ]]; then
        die -q "Kernelmod set is not existing yet. Cannot remove."
    elif [[ -z $(paludis_best-version ${1}) ]]; then
        die -q "DepSpec ${1} is not installed."
    elif [[ $(is_in_kernelmod_set ${1}) == "false" ]]; then
        die -q "DepSpec is not in kernelmod set."
    else
        echo "Removing ${1} from kernelmod set."
        sed -ie "/.*${1/\//\\/}.*/d" ${KERNELMOD_SET_PATH}
    fi
}

### rebuild action ###

describe_rebuild() {
    echo "Rebuild kernel module packages in kernelmod set."
}

do_rebuild() {
    $(paludis_command) --install --preserve-world --dl-reinstall-targets always kernelmod
}

# vim: set ft=eclectic sw=4 sts=4 ts=4 et tw=80 :
