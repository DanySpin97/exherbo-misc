# Copyright 2010 Pierre Lejeune <superheron@gmail.com>
# Distributed under the terms of the GNU General Public License v2

require java

MY_PN="apache-${PN}"
MY_PNV="${MY_PN}-${PV}"

ARTIFACTS=( 'asm:asm:3.1:jar pom'
            'asm:asm-all:3.1:jar pom'
            'asm:asm-parent:3.1:pom'
            'classworlds:classworlds:1.1-alpha-2 1.1:pom'
            'com/google:google:1:pom'
            'com/google/collections:google-collections:1.0:jar pom'
            'com/thoughtworks/qdox:qdox:1.9.2:jar pom'
            'commons-cli:commons-cli:1.0 1.2:jar pom'
            'commons-collections:commons-collections:2.0:jar pom'
            'commons-jxpath:commons-jxpath:1.3:jar pom'
            'commons-lang:commons-lang:1.0 2.1:jar pom'
            'commons-logging:commons-logging:1.0:jar pom'
            'commons-logging:commons-logging-api:1.1:jar pom'
            'doxia:doxia-sink-api:1.0-alpha-4:jar pom'
            'easymock:easymock:1.2_Java1.3:jar pom'
            'jdom:jdom:1.0:jar pom'
            'junit:junit:3.8.1 3.8.2:jar pom'
            'log4j:log4j:1.2.12:jar pom'
            'nekohtml:nekohtml:1.9.6.2:jar pom'
            'nekohtml:xercesMinimal:1.9.6.2:jar pom'
            'org/apache:apache:1 3 4 5 6 7 8:pom'
            'org/apache:apache-jar-resource-bundle:1.4:jar'
            'org/apache/commons:commons-parent:11:pom'
            'org/apache/maven:maven:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-archiver:2.3 2.4:jar pom'
            'org/apache/maven:maven-artifact:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-artifact-manager:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-core:2.0 2.0.1 2.0.5 2.0.6 2.0.9:pom'
            'org/apache/maven:maven-error-diagnostics:2.0 2.0.1 2.0.5 2.0.6 2.0.9:pom'
            'org/apache/maven:maven-model:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-monitor:2.0 2.0.1 2.0.5 2.0.6 2.0.9:pom'
            'org/apache/maven:maven-parent:1 4 5 6 7 8 9 11 13 15 16 18:pom'
            'org/apache/maven:maven-plugin-api:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.9:pom'
            'org/apache/maven:maven-plugin-descriptor:2.0 2.0.1 2.0.5 2.0.6 2.0.9:pom'
            'org/apache/maven:maven-plugin-parameter-documenter:2.0 2.0.1 2.0.5 2.0.6 2.0.9:pom'
            'org/apache/maven:maven-plugin-registry:2.0 2.0.1 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-profile:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-project:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-repository-metadata:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-settings:2.0 2.0.1 2.0.2 2.0.4 2.0.5 2.0.6 2.0.7 2.0.8 2.0.9:pom'
            'org/apache/maven:maven-toolchain:2.0.9:pom'
            'org/apache/maven/doxia:doxia:1.0-alpha-6 1.0-alpha-7 1.0-alpha-10:pom'
            'org/apache/maven/doxia:doxia-sink-api:1.0-alpha-6 1.0-alpha-7 1.0-alpha-10:jar pom'
            'org/apache/maven/plugins:maven-assembly-plugin:2.2-beta-5:jar pom'
            'org/apache/maven/plugins:maven-compiler-plugin:2.0.2:jar pom'
            'org/apache/maven/plugins:maven-install-plugin:2.2:jar pom'
            'org/apache/maven/plugins:maven-jar-plugin:2.2:jar pom'
            'org/apache/maven/plugins:maven-plugins:8 10 14 16 17:pom'
            'org/apache/maven/plugins:maven-remote-resources-plugin:1.1:jar pom'
            'org/apache/maven/plugins:maven-resources-plugin:2.4.2:jar pom'
            'org/apache/maven/plugins:maven-surefire-plugin:2.4.2 2.7.2:jar pom'
            'org/apache/maven/reporting:maven-reporting:2.0 2.0.1 2.0.5 2.0.6 2.0.9:pom'
            'org/apache/maven/reporting:maven-reporting-api:2.0 2.0.1 2.0.5 2.0.6 2.0.9:jar pom'
            'org/apache/maven/scm:maven-scm:1.0-beta-3:pom'
            'org/apache/maven/scm:maven-scm-api:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-manager-plexus:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-managers:1.0-beta-3:pom'
            'org/apache/maven/scm:maven-scm-provider-clearcase:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-provider-cvs-commons:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-provider-cvsexe:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-provider-perforce:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-provider-starteam:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-provider-svn-commons:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-provider-svnexe:1.0-beta-3:jar pom'
            'org/apache/maven/scm:maven-scm-providers:1.0-beta-3:pom'
            'org/apache/maven/scm:maven-scm-providers-cvs:1.0-beta-3:pom'
            'org/apache/maven/scm:maven-scm-providers-svn:1.0-beta-3:pom'
            'org/apache/maven/shared:file-management:1.1:jar pom'
            'org/apache/maven/shared:maven-artifact-resolver:1.0:jar pom'
            'org/apache/maven/shared:maven-common-artifact-filters:1.0-alpha-1 1.0 1.1 1.2 1.3:jar pom'
            'org/apache/maven/shared:maven-downloader:1.1:jar pom'
            'org/apache/maven/shared:maven-filtering:1.0-beta-2 1.0-beta-3 1.0-beta-4:jar pom'
            'org/apache/maven/shared:maven-plugin-testing-harness:1.1:jar pom'
            'org/apache/maven/shared:maven-repository-builder:1.0-alpha-2:jar pom'
            'org/apache/maven/shared:maven-shared-components:4 6 7 8 10 11 12 15:pom'
            'org/apache/maven/shared:maven-shared-io:1.0 1.1:jar pom'
            'org/apache/maven/surefire:maven-surefire-common:2.7.2:jar pom'
            'org/apache/maven/surefire:surefire:2.4.2 2.7.2:pom'
            'org/apache/maven/surefire:surefire-api:2.4.2 2.7.2:jar pom'
            'org/apache/maven/surefire:surefire-booter:2.4.2 2.7.2:jar pom'
            'org/apache/maven/surefire:surefire-junit:2.4.2:jar pom'
            'org/apache/maven/surefire:surefire-junit3:2.7.2:jar pom'
            'org/apache/maven/surefire:surefire-providers:2.4.2 2.7.2:pom'
            'org/apache/maven/wagon:wagon:1.0-alpha-6 1.0-beta-7:pom'
            'org/apache/maven/wagon:wagon-file:1.0-beta-7:jar pom'
            'org/apache/maven/wagon:wagon-http-lightweight:1.0-beta-7:jar pom'
            'org/apache/maven/wagon:wagon-http-shared:1.0-beta-7:jar pom'
            'org/apache/maven/wagon:wagon-providers:1.0-beta-7:pom'
            'org/apache/maven/wagon:wagon-provider-api:1.0-alpha-6 1.0-beta-7:jar pom'
            'org/apache/xbean:xbean:3.4:pom'
            'org/apache/xbean:xbean-reflect:3.4:jar pom'
            'org/codehaus/modello:modello:1.4.1:pom'
            'org/codehaus/modello:modello-core:1.4.1:jar pom'
            'org/codehaus/modello:modello-maven-plugin:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-converters:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-dom4j:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-java:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-jdom:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-stax:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-xdoc:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-xml:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-xpp3:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugin-xsd:1.4.1:jar pom'
            'org/codehaus/modello:modello-plugins:1.4.1:pom'
            'org/codehaus/mojo:animal-sniffer:1.6:jar pom'
            'org/codehaus/mojo:animal-sniffer-maven-plugin:1.6:jar pom'
            'org/codehaus/mojo:animal-sniffer-parent:1.6:pom'
            'org/codehaus/mojo:buildnumber-maven-plugin:1.0-beta-1:jar pom'
            'org/codehaus/mojo:java-boot-classpath-detector:1.6:jar pom'
            'org/codehaus/mojo:mojo:16:pom'
            'org/codehaus/mojo:mojo-parent:23:pom'
            'org/codehaus/mojo/signature:java15:1.0:signature'
            'org/codehaus/plexus:plexus:1.0.4 1.0.5 1.0.8 1.0.9 1.0.10 1.0.11 1.0.12 2.0.2 2.0.3 2.0.6 2.0.7:pom'
            'org/codehaus/plexus:plexus-active-collections:1.0-beta-2:jar pom'
            'org/codehaus/plexus:plexus-archiver:1.0-alpha-7 1.0-alpha-9 1.0-alpha-11 1.0-alpha-12:jar pom'
            'org/codehaus/plexus:plexus-classworlds:1.2-alpha-6 1.2-alpha-7 1.2-alpha-9 2.2.2 2.4:jar pom'
            'org/codehaus/plexus:plexus-cli:1.2:jar pom'
            'org/codehaus/plexus:plexus-compiler:1.5.3:pom'
            'org/codehaus/plexus:plexus-compiler-api:1.5.3:jar pom'
            'org/codehaus/plexus:plexus-compiler-javac:1.5.3:jar pom'
            'org/codehaus/plexus:plexus-compiler-manager:1.5.3:jar pom'
            'org/codehaus/plexus:plexus-compilers:1.5.3:pom'
            'org/codehaus/plexus:plexus-component-annotations:1.5.5:jar pom'
            'org/codehaus/plexus:plexus-component-api:1.0-alpha-15 1.0-alpha-16:pom'
            'org/codehaus/plexus:plexus-component-metadata:1.5.5:jar pom'
            'org/codehaus/plexus:plexus-components:1.1.5 1.1.6 1.1.7 1.1.9 1.1.14 1.1.15 1.1.18:pom'
            'org/codehaus/plexus:plexus-container-default:1.0-alpha-8 1.0-alpha-9 1.0-alpha-9-stable-1 1.0-alpha-15 1.0-alpha-22 1.0-alpha-30 1.5.5:pom'
            'org/codehaus/plexus:plexus-containers:1.0-alpha-15 1.0-alpha-16 1.0-alpha-22 1.0-alpha-30 1.0.3 1.5.5:pom'
            'org/codehaus/plexus:plexus-digest:1.0:jar pom'
            'org/codehaus/plexus:plexus-interactivity-api:1.0-alpha-4:jar pom'
            'org/codehaus/plexus:plexus-interpolation:1.6 1.7 1.12 1.13 1.14:jar pom'
            'org/codehaus/plexus:plexus-io:1.0-alpha-1 1.0-alpha-3 1.0-alpha-4:jar pom'
            'org/codehaus/plexus:plexus-resources:1.0-alpha-5:jar pom'
            'org/codehaus/plexus:plexus-tools:1.0.8:pom'
            'org/codehaus/plexus:plexus-utils:1.0.4 1.0.5 1.1 1.2 1.3 1.4.1 1.4.2 1.4.5 1.4.6 1.4.9 1.5.1 1.5.5 1.5.6 1.5.8 1.5.12 1.5.15 2.0.1 2.0.5 2.0.6:jar pom'
            'org/codehaus/plexus:plexus-velocity:1.1.3:jar pom'
            'org/sonatype/aether:aether-api:1.11:jar pom'
            'org/sonatype/aether:aether-connector-wagon:1.11:jar pom'
            'org/sonatype/aether:aether-impl:1.11:jar pom'
            'org/sonatype/aether:aether-parent:1.11:pom'
            'org/sonatype/aether:aether-spi:1.11:jar pom'
            'org/sonatype/aether:aether-util:1.11:jar pom'
            'org/sonatype/forge:forge-parent:3 4 6 7:pom'
            'org/sonatype/plexus:plexus-build-api:0.0.3 0.0.4:jar pom'
            'org/sonatype/plexus:plexus-cipher:1.4:jar pom'
            'org/sonatype/plexus:plexus-sec-dispatcher:1.3:jar pom'
            'org/sonatype/sisu:sisu-guice:2.9.4:jar pom:no_aop'
            'org/sonatype/sisu:sisu-inject:2.1.1:pom'
            'org/sonatype/sisu:sisu-inject-bean:2.1.1:jar pom'
            'org/sonatype/sisu:sisu-inject-plexus:2.1.1:jar pom'
            'org/sonatype/sisu:sisu-parent:2.1.1:pom'
            'org/sonatype/sisu/inject:guice-bean:2.1.1:pom'
            'org/sonatype/sisu/inject:guice-parent:2.9.4:pom'
            'org/sonatype/sisu/inject:guice-plexus:2.1.1:pom'
            'org/sonatype/spice:spice-parent:10 12:pom'
            'regexp:regexp:1.3:jar pom'
            'velocity:velocity:1.4:jar pom'
            'velocity:velocity-dep:1.4:jar pom' )

SUMMARY="Apache Maven - Project Management and Comprehension Tool"
DESCRIPTION="
Apache Maven is a software project management and comprehension tool. Based on the concept of a
project object model (POM), Maven can manage a project's build, reporting and documentation from a
central piece of information.
"
HOMEPAGE="http://${PN}.apache.org"

set_downloads() {
    DOWNLOADS="bootstrap?  ( mirror://apache/${PN}/binaries/${MY_PNV}-bin.tar.gz )
               !bootstrap? ( mirror://apache/${PN}/source/${MY_PNV}-src.tar.gz
    "
    local groupId= artifactId= versions= exts= suffix=
    for artifact in "${ARTIFACTS[@]}" ; do
        IFS=":" read -rs groupId artifactId versions exts suffix <<< "${artifact}"
        for version in ${versions}; do
            for ext in ${exts}; do
                if [[ "${ext}" == "jar" && -n "${suffix}" ]]; then
                    DOWNLOADS+="mirror://maven2/${groupId}/${artifactId}/${version}/${artifactId}-${version}-${suffix}.${ext}
                    "
                else
                    DOWNLOADS+="mirror://maven2/${groupId}/${artifactId}/${version}/${artifactId}-${version}.${ext}
                    "
                fi
            done
        done
    done
    DOWNLOADS+=" )"
}

set_downloads

LICENCES="Apache-2.0"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS="bootstrap [[ description = [ Bootstrap ${PN} with a pre-compiled binary rather than an
                                        already installed ${PN}. ] ]]"

UPSTREAM_DOCUMENTATION="${HOMEPAGE}/guides/index.html"
UPSTREAM_RELEASE_NOTES="${HOMEPAGE}/docs/${PV}/release-notes.html"

WORK="${WORKBASE}/${MY_PNV}"

M2_REPOSITORY="${WORKBASE}/repository"

emvn() {
    edo mvn --batch-mode --offline \
            "-D${PN}.home=${IMAGE}/usr/share/${MY_PNV}" \
            "-D${PN}.repo.local=${M2_REPOSITORY}" "${@}"
}

pkg_pretend() {
    if ! option bootstrap ; then
        if ! has_version dev-java/maven ; then
            ewarn "You need ${PN} installed to compile ${PN} from source."
            ewarn "Try installing ${PN}[bootstrap]"
            die "Could not find ${PN} to bootstrap with"
        else
            ewarn "The maven mirror you will use may hate wget as download agent."
            ewarn "Make sure you put \"EXTRA_WGET=--user-agent=NoSuchBrowser/1.0\""
            ewarn "or something similar in your bashrc to avoid download problems."
        fi
    fi
}

src_unpack() {
    if option bootstrap ; then
        default
    else
        # Prevent unpacking of jar files
        unpack "${MY_PNV}-src.tar.gz"
    fi
}

src_prepare() {
    if ! option bootstrap ; then
        edo mkdir -p "${M2_REPOSITORY}"
        local groupId= artifactId= versions= exts= suffix= repository_path=
        for artifact in "${ARTIFACTS[@]}" ; do
            IFS=":" read -rs groupId artifactId versions exts suffix <<< "${artifact}"
            for version in ${versions}; do
                repository_path="${M2_REPOSITORY}/${groupId}/${artifactId}/${version}"
                edo mkdir -p "${repository_path}"
                for ext in ${exts}; do
                    if [[ "${ext}" == "jar" && -n "${suffix}" ]]; then
                        edo cp "${FETCHEDDIR}/${artifactId}-${version}-${suffix}.${ext}" "${repository_path}"
                    else
                        edo cp "${FETCHEDDIR}/${artifactId}-${version}.${ext}" "${repository_path}"
                    fi
                done
            done
        done
    fi
}

src_compile() {
    if ! option bootstrap ; then
        emvn compile
    fi
}

src_test() {
    if ! option bootstrap ; then
        emvn test
    fi
}

src_install() {
    if option bootstrap ; then
        dodir /usr/share
        edo cp -r "${WORK}" "${IMAGE}"/usr/share/
    else
        emvn -Dmaven.test.skip=true install
        dodir /usr/share
        edo tar zxf "${WORK}"/"${MY_PN}"/target/"${MY_PNV}"-bin.tar.gz --no-same-owner -C "${IMAGE}"/usr/share
    fi
    dodir /usr/bin
    dosym /usr{/share/"${MY_PNV}",}/bin/mvn
}

